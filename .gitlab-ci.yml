stages:
  - preview

image: oven/bun:1.1.20

variables:
  ASTRO_TELEMETRY_DISABLED: "1"

default:
  before_script:
    - bun install --frozen-lockfile

preview:github:
  stage: preview
  script:
    - bun run docs:build
    - |
      bun run docs:preview -- --host 0.0.0.0 --port 4321 > preview.log 2>&1 &
      PREVIEW_PID=$!
      trap "kill $PREVIEW_PID" EXIT
      for attempt in $(seq 1 15); do
        if curl -fsS http://127.0.0.1:4321 >/dev/null; then
          break
        fi
        sleep 1
      done
      curl -fsS http://127.0.0.1:4321 > preview-home.html
  artifacts:
    when: always
    paths:
      - preview.log
      - preview-home.html
